<html>
    <head>
    <meta charset="UTF-8">
    <title>Mobile Studio v0.0.1 - Editor</title>
        <link rel="stylesheet" href="css/jqueryUI/jquery-ui.min.css">
        <link rel="stylesheet" href="css/jqueryUI/jquery-ui.structure.min.css">
        <link rel="stylesheet" href="css/jqueryUI/jquery-ui.theme.min.css">
        <link rel="stylesheet" href="css/jqueryUI/jquery.ui.ruler.css">
        
        <!--link rel="stylesheet" href="css/bootstrap/bootstrap.min.css">
        <link rel="stylesheet" href="css/bootstrap/bootstrap-theme.min.css">
        <script src="js/bootstrap/bootstrap.min.js"></script-->
        
        <script src="js/translator.js"></script>
        <script src="js/editor-backend.js"></script>
        
        <link rel="stylesheet" href="css/editor.css">

        <script>
            
            //SupportedCSS: CSS tags that can be translated by NS
            var supportedCSS = ['color','background-color','background-image','background-repeat','background-position','background-size','border-color','border-width','border-radius','font','font-family','font-size','font-style','font-weight','text-align','text-decoration','text-transform','letter-spacing','z-index','clip-path','vertical-align','horizontal-align','margin','margin-top','margin-right','margin-bottom','margin-left','width','height','min-width','min-height','padding','padding-top','padding-right','padding-bottom','padding-left','visibility','opacity'];
            
            //var messageReceived = null;
            window.$ = window.jQuery = require('./js/jquery-3.0.0.min.js');
            require('./js/jquery-ui.min.js');
            require('./js/jquery.ui.ruler.js');
            require('./js/colResizable-1.6.min.js');
            var model = require('./classes.js');
            let application = new model.Application(); 
            $(window).ready(function() {
                  
                //Graphic Initialization
               // $( "#mainContent" ).resizable();
                $( "#componentsPanel" ).resizable();
                /*$("#mainTable").colResizable({
                    liveDrag:true
                });*/
                $( "#componentsPanel" ).droppable();
                $( "#mainContent" ).droppable();
                $( "#propertyPanel" ).hide();

                $( "#mainContent" ).ruler();
                  
                //Gather data from main (FOR NOW ONLY PATH)
                const {ipcRenderer} = require('electron');
                
                ipcRenderer.on('asynchronous-message', (event, arg) => {
                    //messageReceived = arg;
                    switch(arg[0]){
                        case "initialization": {initialization(arg); break;}
                        //default: console.log(arg);
                    }
                });
                
            });
            
        
            
            function deleteElement(idToDelete,winId){
                    $("#"+idToDelete).remove();
                    $(".infoHovering").remove();
                    $("#propertyPanel").hide();
                    //Delete from model!!!
                    //application.screens.splice(idToDelete,1);
                    if (winId==null){
                        delete application.screens[idToDelete];
                        application.numberOfScreens--;
                    }else{
                        delete application.screens[winId].components[idToDelete];
                        application.screens[winId].numberOfComponents--;
                    }
                }
            
            
            function buildProjectForAndroid(){
                $("#loadingPanel").show();
                console.log("DO TRANSLATION HERE!")
            }
            
            
            function buildPropertiesPanel(winId,compId){
                var styles = `<section style="max-height:30%; overflow: scroll">
                                                        <table>
                                                            <tbody>`;
                                      for(var i=0;i<supportedCSS.length;i++){
                                          var property = supportedCSS[i];
                                          var propertyValue;
                                          if(!compId)  propertyValue = $("#"+application.screens[winId].id).css(property);
                                          else  propertyValue = $("#"+application.screens[winId].components[compId].id).css(property);
                                          styles += `<tr>
                                                        <td>`+property+`</td>
                                                        <td style="float:right;">
                                                            <input type="text" value='`+propertyValue+`'/>
                                                        </td>
                                                    </tr>`;
                                      }
                                      styles +=        `</tbody>
                                                    </table>
                                                </section>`;
                                      var attributeToSearch;
                                      if (!compId) attributeToSearch = application.screens[winId];
                                      else attributeToSearch = application.screens[winId].components[compId];
                                      
                                      var attributes = `<table>
                                                <tbody>
                                                    <tr>
                                                        <td> ID </td>
                                                        <td style="float:right;">
                                                            <input type="text" value="`+attributeToSearch.id+`"/>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td> Class </td>
                                                        <td style="float:right;"><input type="text" placeholder="unset" /></td>
                                                    </tr>
                                                    <tr>
                                                        <td> Layout </td>
                                                        <td style="float:right;">
                                                            <input type="text" value="`+attributeToSearch.layout+`"/>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>`;
                                      
                                      var actions = `<table>
                                                <tbody>
                                                    <tr>
                                                        <td> onclick </td>
                                                        <td style="float:right;"><input type="button" /></td>
                                                    </tr>
                                                </tbody>
                                            </table>`
                                      
                                      var panelDetailContent = `
                                            <h1>`+attributeToSearch.id+`</h1>
                                            <h3> Window </h3>
                                            
                                            <h2> Attributes </h2>
                                        `+attributes+`
                                            <h2> Styles </h2>
                                        `+styles+`
                                            <h2> Actions </h2>
                                        `+actions+`
                                             <input value="DELETE" type="submit" onclick="deleteElement('`+attributeToSearch.id+`',null);">`;

                                      $("#propertyPanel").html(panelDetailContent); 
            }


            
            function initialization(config){        //config[1]: working path [it is in 0 position]
                
                buildNewProject(config);        //Check if we need to create a new project
                $("#loadingPanel").hide();
                
                
                
                /*****************************FRONT END*******************************/
                //$("#filePanel").append(config[1]);
                
                for(var i=0; i<10; i++){
                    if (i==0) $("#componentsPanel").append("<div class='component ui-widget-content'>SCREEN</div>");
                    if (i==1) $("#componentsPanel").append("<div class='component ui-widget-content'>TEXT</div>");
                    else $("#componentsPanel").append("<div class='component ui-widget-content'>"+i+"</div>");
                }
                
                
                $( ".component" ).draggable({
                    opacity: 0.7,
                    helper: "clone",
                    //grid: [ 20, 20 ]
                });
                
                
                
                $( "#mainContent" ).droppable({
                  drop: function( event, ui ) {
                      /*console.log(ui);
                      console.log(this);
                      console.log(event);*/
                      
                      switch (ui.draggable[0].innerText){
                          case "SCREEN": {
                              var leftOffset = ui.position.left - $("#componentsPanel").width();
                              var newId = application.numberOfScreens;
                              var newScreen = new model.Screen("win"+newId);
                              //application.screens.push("win"+newId);
                              //TODO: Analyze following
                              //application.screens.push(newScreen);
                              application.screens["win"+newId] = newScreen;
                              application.numberOfScreens++;
                              var firstWindowString = ""; 
                              if (application.numberOfScreens==1) firstWindowString = "(Starting Window)";
                              var sampleWindow = `<div id='win`+newId+`' class='window drawn-element' style='top:`+ui.position.top+`; left: `+leftOffset+`;'>
                                                  <span>win`+newId+` `+firstWindowString+`</span>
                                                  </div>`;
                              //$(sampleWindow).appendTo($(this));
                              $("#mainContent").append(sampleWindow);
                              $(".window").draggable();
                              
                              //InfoBox
                              $(".window").click(function(sender){
                                  if (sender.target.id.substring(0,3)=="win"){
                                      buildPropertiesPanel(""+sender.target.id+"",null);
                                      
                                      $("#propertyPanel").show();
                                  }else{
                                      buildPropertiesPanel(""+this.id+"",""+sender.target.id+"");
                                      
                                      $("#propertyPanel").show(); 
                                  }
                              });
                              $(".window").droppable({
                                  drop: function( event, ui ) {
                                        console.log("Dropping element!");
                                        
                                          switch (ui.draggable[0].innerText){
                                              case "TEXT": {
                                                  //Create Graphics
                                                  //TODO: Create better ID!!!
                                                  var id = "label"+application.screens[this.id].numberOfComponents;
                                                  var sampleTextHTML = "<div id='"+id+"' style='border-width: 0' class='drawn-element label'>Label</div>";
                                                  $(this).append(sampleTextHTML);
                                                  //Update Model
                                                  //Setting a property via constructor
                                                  var component = new model.Component (id,"label");
                                                  //Creation of an attribute at run time:
                                                
                                                  component.text = "Label"
                                                  //application.screens[this.id].components.push(component);
                                                  application.screens[this.id].components[""+id+""] = component;
                                                  application.screens[this.id].numberOfComponents++;
                                                  //console.log(this.id);
                                                  }
                                                  break;
                                              }
                                     
                                  }
                      });    
                      //ui.draggable.clone().appendTo($(this)).draggable();

                  }
    
                 }}});
                
                
            }
                
           
            
        </script>
    </head>
    <body>
       <nav>
           Mobile Studio
           <button id="androidGo">Compile for Android</button>
           <button id="iOSGo">Compile for iOS</button>
       </nav>
       <section id="loadingPanel">
           <h1 style="color:white;">LOADING</h1>
       </section>
        <table id="mainTable" style="position:absolute; height:100%;">
            <tr>
                <td id="componentsPanel"></td>
                <td id="mainContent" style="position:relative;"> <!--TODO: rename in mainContentContainer
                     <section id="realMainContent" style="background-color:red; width:100%; height:100%;"></section>        -->
                <td id="propertyPanel"><small>Properties</small><br></td>

                </td>
            </tr>
        
        </table>

    </body>
</html>