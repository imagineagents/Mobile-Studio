<html>
    <head>
    <meta charset="UTF-8">
    <title>Mobile Studio v0.0.1 - Editor</title>
        <link rel="stylesheet" href="css/jqueryUI/jquery-ui.min.css">
        <link rel="stylesheet" href="css/jqueryUI/jquery-ui.structure.min.css">
        <link rel="stylesheet" href="css/jqueryUI/jquery-ui.theme.min.css">
        <link rel="stylesheet" href="css/jqueryUI/jquery.ui.ruler.css">
        
        <!--link rel="stylesheet" href="css/bootstrap/bootstrap.min.css">
        <link rel="stylesheet" href="css/bootstrap/bootstrap-theme.min.css">
        <script src="js/bootstrap/bootstrap.min.js"></script-->
        
        <script src="js/translator.js"></script>
        
        <link rel="stylesheet" href="css/editor.css">

        <script>
            //var messageReceived = null;
            window.$ = window.jQuery = require('./js/jquery-3.0.0.min.js');
            require('./js/jquery-ui.min.js');
            require('./js/jquery.ui.ruler.js');
            var model = require('./classes.js');
            let application = new model.Application(); 
            $(window).ready(function() {
                  
                //Graphic Initialization
                //$( "#filePanel" ).resizable();
                $( "#componentsPanel" ).resizable();
                $( "#componentsPanel" ).droppable();
                $( "#mainContent" ).droppable();

                $( "#mainContent" ).ruler();
                  
                //Gather data from main (FOR NOW ONLY PATH)
                const {ipcRenderer} = require('electron');
                
                ipcRenderer.on('asynchronous-message', (event, arg) => {
                    //messageReceived = arg;
                    switch(arg[0]){
                        case "initialization": {initialization(arg); break;}
                        //default: console.log("error");
                    }
                });
                
            });
            
            function getFiles (dir, files_){
                var fs = require('fs');
                files_ = files_ || [];
                var files = fs.readdirSync(dir);
                for (var i in files){
                    var name = dir + '/' + files[i];
                    if (fs.statSync(name).isDirectory()){
                        getFiles(name, files_);
                    } else {
                        files_.push(name);
                    }
                }
                return files_;
            }
            
            function deleteElement(idToDelete){
                    $("#"+idToDelete).remove();
                    $(".infoHovering").remove();
                    //Delete from model
                }
            
            
            function buildProjectForAndroid(){
                $("#loadingPanel").show();
                console.log("DO TRANSLATION HERE!")
            }


            
            function initialization(config){        //config[1]: working path [it is in 0 position]
                var path = config[1][0];
                var name = "testName";
                //Backend stuff
                //TODO: WORK HERE
                var sys = require('util'),
                    childProcess = require('child_process'),
                    fixPath = require('fix-path');
                fixPath();      //Required to reset path and execute commands
                var cmdBuildPrj = '/usr/local/bin/tns create '+name+' --ng';        //TODO: CHECK FOR WIN
                //var ns = require("nativescript");
                //console.log(ns);
                /*var cmdTest = 'mkdir provadir';
                console.log("NOW LETS SEE ALL THE FILES IN THE DESKTOP:")
                console.log(getFiles(config[1][0]));                
                console.log("Going to execute command: "+cmdTest);
                //console.log(config[1][0]);
                exec(cmdTest, {cwd: ""+config[1][0]+""}, function(error, stdout, stderr) {
                    console.log("cd: " + error + " : "  + stdout);
                  // command output is in stdout
                });
                /*exec(cmdTest, function(error, stdout, stderr) {
                    console.log(stdout);
                  // command output is in stdout
                });*/

                //const execSync = require('child_process').execSync;
                /*****DECOMMENT NEXT LINES IF YOU WANT TO BUILD NS PROJECT****
                childProcess.execSync(cmdBuildPrj, {cwd: path}, function(error, stdout, stderr) {
                    //Callback function to execute when command is executed
                    console.log("cmd: " + error + " : "  + stdout);
                    $("#loadingPanel").hide();
                });*/
                
                /*
                CHECK THIS FUNCTION IF YOU WANT TO DISPLAY A PROPER CONSOLE
                childProcess.stdout.on('data', function(data) {
                    console.log(data); 
                });*/
                /*
                files = getFiles(path+"/"+name);

                for (var i in files){
                    $("#filePanel").append(files[i]+"<br>");
                }*/
                
                //$("#filePanel").hide();
                                
                $("#loadingPanel").hide();
                
                
                /*****************************FRONT END*******************************/
                //$("#filePanel").append(config[1]);
                
                for(var i=0; i<10; i++){
                    if (i==0) $("#componentsPanel").append("<div class='component ui-widget-content'>SCREEN</div>");
                    if (i==1) $("#componentsPanel").append("<div class='component ui-widget-content'>TEXT</div>");
                    else $("#componentsPanel").append("<div class='component ui-widget-content'>"+i+"</div>");
                }
                
                
                $( ".component" ).draggable({
                    opacity: 0.7,
                    helper: "clone",
                    //grid: [ 20, 20 ]
                });
                
                
                
                $( "#mainContent" ).droppable({
                  drop: function( event, ui ) {
                      /*console.log(ui);
                      console.log(this);
                      console.log(event);*/
                      
                      switch (ui.draggable[0].innerText){
                          case "SCREEN": {
                              var leftOffset = ui.position.left - $("#componentsPanel").width();
                              var newId = application.screens.length;
                              var newScreen = new model.Screen("win"+newId);
                              //application.screens.push("win"+newId);
                              //TODO: Analyze following
                              application.screens.push(newScreen);
                              application.screens["win"+newId] = newScreen;
                              var sampleWindow = "<div id='win"+newId+"' class='window drawn-element' style='top:"+ui.position.top+"; left: "+leftOffset+";'>Window</div>";
                              //$(sampleWindow).appendTo($(this));
                              $("#mainContent").append(sampleWindow);
                              $(".window").draggable();
                              
                              //InfoBox
                              $(".window").click(function(sender){
                                  console.log(sender.target.id);
                                  var infoPanel =   `<div class="infoHovering" style="top:`+ui.position.top+`; left: `+(leftOffset+400)+`;">
                                                        <h1>Screen`+application.screens[""+sender.target.id+""].id+`</h1>
                                                        Screen UI Element
                                                        <br/>
                                                        id: <input type="text" value="`+application.screens[""+sender.target.id+""].id+`"/>
                                                        <br/>
                                                        layout: <input type="text" value="`+application.screens[""+sender.target.id+""].layout+`"/>
                                                        <br/>
                                                        <input value="DELETE" type="submit" onclick="deleteElement('`+application.screens[""+sender.target.id+""].id+`');">
            
                                                    </div>`;
                                  //var infoPanel = "<h1>Ciaone</h1>";
                                  $("#mainContent").append(infoPanel);
                               
                              });
                              $(".window").droppable({
                                  drop: function( event, ui ) {
                                        console.log("Dropping textbox!");
                                        
                                          switch (ui.draggable[0].innerText){
                                              case "TEXT": {
                                                  //Create Graphics
                                                  var sampleTextHTML = "<div id='label0' style='border-width: 1' class='drawn-element label'>HELLO WORLD!</div>";
                                                  $(this).append(sampleTextHTML);
                                                  //Update Model
                                                  //Setting a property via constructor
                                                  var component = new model.Component ("label0","label");
                                                  //Creation of an attribute at run time:
                                                  component.text = "HELLO WORLD"
                                                  application.screens[this.id].components.push(component);
                                                  //console.log(this.id);
                                                  }
                                                  break;
                                              }
                                  }
                      })    
                      //ui.draggable.clone().appendTo($(this)).draggable();

                  }
    
                 }}});
                
                
            }
                
            
        </script>
    </head>
    <body>
       <nav>
           Mobile Studio
           <button id="androidGo">Compile for Android</button>
           <button id="iOSGo">Compile for iOS</button>
       </nav>
       <section id="loadingPanel" style="position:absolute; width:100%; height:100%; top: 0; left:0; background:black; opacity:0.8; z-index:20;">
           <h1 style="color:white;">LOADING</h1>
       </section>
        <table style="position:absolute;">
            <tr>
                <!--td id="filePanel"><small>Working Directory</small><br></td-->
                <td id="componentsPanel"></td>
                <td id="mainContent" style="position:relative;"> <!--TODO: rename in mainContentContainer
                     <section id="realMainContent" style="background-color:red; width:100%; height:100%;"></section>        -->
                </td>
            </tr>
        
        </table>
        <!--
        <aside id="filePanel" style="display:table-cell">Active Files</aside>
        <aside id="componentsPanel" style="display:table-cell"></aside>-->
    </body>
</html>