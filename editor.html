<html>
    <head>
    <meta charset="UTF-8">
    <title>Mobile Studio v0.0.1 - Editor</title>
        <link rel="stylesheet" href="css/jqueryUI/jquery-ui.min.css">
        <link rel="stylesheet" href="css/jqueryUI/jquery-ui.structure.min.css">
        <link rel="stylesheet" href="css/jqueryUI/jquery-ui.theme.min.css">
        <link rel="stylesheet" href="css/jqueryUI/jquery.ui.ruler.css">
        <link rel="stylesheet" href="css/ios.css">
        
        <!-- link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" -->
        <link rel="stylesheet" href="css/bootstrap/bootstrap-theme.min.css">
        <!--script src="js/bootstrap/bootstrap.min.js"></script-->
        
        <script src="js/translator.js"></script>
        <script src="js/editor-backend.js"></script> 
         
        <script src="cm/lib/codemirror.js"></script>
        <script src="cm/mode/css/css.js"></script>
        <script src="cm/mode/xml/xml.js"></script>
        <script src="cm/mode/javascript/javascript.js"></script>
        <script src="cm/mode/htmlmixed/htmlmixed.js"></script>
        
        <!--script src="js/jstree/jstree.min.js"></script-->

        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="cm/lib/codemirror.css">
        <link rel="stylesheet" href="cm/theme/lesser-dark.css">
        
        
        <!--link rel="stylesheet" href="js/jstree/themes/default/style.min.css" /-->
        
        <link href="js/fancytree/skin-lion/ui.fancytree.min.css" rel="stylesheet">
        <!--script src="js/fancytree/jquery.fancytree-all.min.js"></script-->
        
        <link rel="stylesheet" href="css/editor.css">

        <script>
            
            //SupportedCSS: CSS tags that can be translated by NS
            var supportedCSS = ['color','background-color','background-image','background-repeat','background-position','background-size','border-color','border-width','border-radius','font','font-family','font-size','font-style','font-weight','text-align','text-decoration','text-transform','letter-spacing','z-index','clip-path','vertical-align','horizontal-align','margin','margin-top','margin-right','margin-bottom','margin-left','width','height','min-width','min-height','padding','padding-top','padding-right','padding-bottom','padding-left','visibility','opacity'];
            
            //var messageReceived = null;
            window.$ = window.jQuery = require('./js/jquery-3.0.0.min.js');
            require('./js/jquery-ui.min.js');
            require('./js/jquery.ui.ruler.js');
            require('./js/colResizable-1.6.min.js');
            //require('./js/jstree/jstree.js');
            require('./js/fancytree/jquery.fancytree-all.min.js');
            //require('./js/jquery.zoomooz.js');
            var model = require('./classes.js');
            let application = new model.Application(); 
            platformToPreview = "ios";
            $(window).ready(function() {
                  
                //Graphic Initialization
               // $( "#mainContent" ).resizable();
                $( "#componentsPanel" ).resizable();
                /*$("#mainTable").colResizable({
                    liveDrag:true
                });*/
                $( "#componentsPanel" ).droppable();
                $( "#mainContent" ).droppable();
                $( "#propertyPanel" ).hide();

                $( "#mainContent" ).ruler();
                
                $("#previewPlatformSelector").change(function(){
                    if(this.value=="ios"){
                        $(".drawn-element").removeClass("android");
                        $(".drawn-element").addClass("ios");
                        platformToPreview = "ios";
                    }else{
                        $(".drawn-element").removeClass("ios");
                        $(".drawn-element").addClass("android");
                        platformToPreview = "android";

                    }
                });
                

                
                $("#mainContent").css("zoom",1);

                //IMPROVE ZOOM
                $( "#mainContent").on("mousewheel", function(e) {
                    if (e.ctrlKey) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        console.log("scrolling!");
                        console.log(e);
                        // perform desired zoom action here
                        var newZoom = 1;
                        if (e.originalEvent.wheelDelta>0)
                          //  $(this).zoomTo({targetsize:1.25, duration:600});    //ZOOMOOZ
                            newZoom = parseFloat($("#mainContent").css("zoom"))*1.1;
                        else
                           // $(this).zoomTo({targetsize:0.75, duration:600});     //ZOOMOOZ
                            newZoom = parseFloat($("#mainContent").css("zoom"))*0.9;
                        $(this).animate({'zoom':newZoom},1);
                        console.log("newZoom: "+newZoom+" wheelData: "+e.originalEvent.wheelDelta);

                    }
                });

                  
                //Gather data from main (FOR NOW ONLY PATH)
                const {ipcRenderer} = require('electron');
                
                ipcRenderer.on('asynchronous-message', (event, arg) => {
                    //messageReceived = arg;
                    switch(arg[0]){
                        case "initialization": {initialization(arg); break;}
                        //default: console.log(arg);
                    }
                });
                /*
                $("#mainContent").append(`
                                     <div id="selector" style="background-color: blue; position:absolute; border: 4px solid #2aabd2;"></div>`);*/
                
                
                //Only at the very end we should set up a style (iOS/Android)
                //ios standard visualization
                $(".drawn-element").addClass("ios");
                platformToPreview = "ios";
            });
            
        
            
            function deleteElement(idToDelete,winId){
                    $("#"+idToDelete).remove();
                    $(".infoHovering").remove();
                    $("#propertyPanel").hide();
                    //Delete from model!!!
                    //application.screens.splice(idToDelete,1);
                    console.log("About to remove: winId = "+winId+", idToDelete = "+idToDelete);
                    if (winId==null){
                        delete application.screens[idToDelete];
                        application.numberOfScreens--;
                    }else{
                        delete application.screens[winId].components[idToDelete];
                        application.screens[winId].numberOfComponents--;
                    }
                }
            
            
            function buildProjectForAndroid(){
                $("#loadingPanel").show();
                console.log("DO TRANSLATION HERE!")
            }
            
            function setNewCss(event, attributeID, property){                   //Incremental CSS UPDATE 
                $("#"+attributeID+"").css(""+property+"",""+this.value+"");
                //console.log(this);
            }
            
            function setNewAttr(event,attrType,oldAttr,compWin,winId,property){        //compWin = not defined if Window, id if comp
                switch(attrType){
                    case "id":{
                        newId = this.value;
                        $("#"+oldAttr).attr("id",newId);
                        if(!compWin){
                            if (application.screens[""+newId+""]){
                                alert("You must use an unique id!");
                                return;
                            }
                            application.screens[""+oldAttr+""].id = ""+newId+"";
                            application.screens[""+newId+""] = application.screens[""+oldAttr+""];
                            delete application.screens[""+oldAttr+""];
                        }else{
                            if (application.screens[""+winId+""].components[""+newId+""]){
                                alert("You must use an unique id!");
                                return;
                            }
                            application.screens[""+winId+""].components[""+oldAttr+""].id = ""+newId+"";
                            application.screens[""+winId+""].components[""+newId+""] = application.screens[""+winId+""].components[""+oldAttr+""];
                            delete application.screens[""+winId+""].components[""+oldAttr+""];

                        }
                        $("#titlePanelDetail").val(newId);
                    }
                        break;
                    case "class": //similar to ID
                        break;
                    case "other":{
                        if(property!="text") $("#"+oldAttr).attr(""+property+"",this.value);    //CHECK THIS
                        else $("#"+oldAttr).text(this.value);
                        application.screens[""+winId+""].components[""+oldAttr+""].specificAttributes[""+property+""] = this.value;

                    }
                        
                }
                
            }
            
            
            function buildPropertiesPanel(winId,compId){
              var styles = `<section style="max-height:200px; overflow: scroll">
                                                        <table>
                                                            <tbody>`;
                
              var attributeToSearch;
              if (!compId) attributeToSearch = application.screens[winId];
              else attributeToSearch = application.screens[winId].components[compId];

              for(var i=0;i<supportedCSS.length;i++){
                  var property = supportedCSS[i];
                  var propertyValue = $("#"+attributeToSearch.id).css(property);
                  styles += `<tr>
                                <td>`+property+`</td>
                                <td style="float:right;">
                                    <input type="text" value='`+propertyValue+`' onchange="setNewCss.call(this,event,'`+attributeToSearch.id+`','`+property+`');"/>
                                </td>
                            </tr>`;
              }
              styles +=        `</tbody>
                            </table>
                        </section>`;


              var attributes = `<table>
                        <tbody>
                            <tr>
                                <td> ID </td>
                                <td style="float:right;">
                                    <input type="text" value="`+attributeToSearch.id+`" onchange="setNewAttr.call(this,event,'id','`+attributeToSearch.id+`',`+compId+`,`+winId+`)"/>
                                </td>
                            </tr>
                            <tr>
                                <td> Class </td>
                                <td style="float:right;"><input type="text" placeholder="unset" /></td>
                            </tr>`;
              if (!compId) attributes+=`              
                            <tr>
                                <td> Layout </td>
                                <td style="float:right;">
                                    <input type="text" value="`+attributeToSearch.layout+`"/>
                                </td>
                            </tr>`; //Insert here other window-specific attributes
                else for(var i in attributeToSearch.specificAttributes){
                    attributes+=`              
                            <tr>
                                <td>`+i+`</td>
                                <td style="float:right;">
                                    <input type="text" value="`+attributeToSearch.specificAttributes[i]+`" onchange="setNewAttr.call(this,event,'other','`+attributeToSearch.id+`','`+compId+`','`+winId+`','`+i+`')"/>
                                </td>
                            </tr>`;
                }
              attributes +=`
                        </tbody>
                    </table>`;

              var actions = `<table>
                        <tbody>
                            <tr>
                                <td> onclick </td>
                                <td style="float:right;"><input type="button" onclick="drawLine.call(this,event,'`+compId+`','`+winId+`');"/></td>
                            </tr>
                        </tbody>
                    </table>`
              var containingWindow;
              if (!compId) containingWindow = null;
                else containingWindow = winId;
              var panelDetailContent = `
                    <h1 id="titlePanelDetail">`+attributeToSearch.id+`</h1>
                    <h3>`+attributeToSearch.type+`</h3>

                    <h2> Attributes </h2>
                `+attributes+`
                    <h2> Styles </h2>
                `+styles+`
                    <h2> Actions </h2>
                `+actions+`
                     <input value="DELETE" type="submit" onclick="deleteElement('`+attributeToSearch.id+`','`+containingWindow+`');">`;

              $("#properties").html(panelDetailContent); 
            }
            
            function setSelectionBox(elementToWrap){
                $("#selector").css("top",""+(parseFloat(elementToWrap.target.style.top)-3.0)+"")
                $("#selector").css("left",""+(parseFloat(elementToWrap.target.style.left)-3.0)+"");
                $("#selector").css("width",elementToWrap.target.style.width);
                $("#selector").css("height",elementToWrap.target.style.height);
            }
            
            function initializeWindowEvents(){
                $(".window").draggable();
                  //DetailPanel
                  $(".window").click(function(sender){
                      //console.log(sender);
                      if (sender.target.id.substring(0,3)=="win"){
                          buildPropertiesPanel(""+sender.target.id+"",null);
                          //setSelectionBox(sender)
                          $("#propertyPanel").show();
                      }else{
                 //       console.log(sender);

                          buildPropertiesPanel(""+this.id+"",""+sender.target.id+"");
                          //setSelectionBox(sender)

                          $("#propertyPanel").show(); 
                      }
                  });
                  $(".window").droppable({
                                  drop: function( event, ui ) {
                                      //This function controls what happens when dropping an element in a Window
                                      //2 behaviour to analyze:
                                      //1) a component is taken from component panel
                                      //2) an already present component get moved
                                      
                                      //1) the ui.draggable[0] has "component" class
                                      x = ui.draggable[0];
                                      if ($.inArray("component", ui.draggable[0].classList)>=0){
                                        console.log("Dropping element!");
                                        var id = "";
                                        var componentHTML = "";
                                        var type = ui.draggable[0].innerText;
                                        //TODO: Create better ID
                                        id = type+application.screens[this.id].numberOfComponents;
                                        var layout = application.screens[this.id].layout;
                                        switch (type){
                                              case "Label": 
                                                  componentHTML = "<div id='"+id+"' class='drawn-element label  "+layout+" "+platformToPreview+"'>Label</div>";
                                                  break;        
                                              case "Button":
                                                  componentHTML = "<button id='"+id+"' class='drawn-element button "+layout+" "+platformToPreview+"' value='Button'></button>";
                                                  break;
                                              case "TextField":
                                                  componentHTML = "<input type='text' id='"+id+"' class='drawn-element textfield "+layout+" "+platformToPreview+"' value='Insert Text Here'/>";
                                                  break;
                                              case "TextView":
                                                  componentHTML="<input type='textarea' id='"+id+"' class='drawn-element textarea "+layout+" "+platformToPreview+"' value='Insert Multiline Text Here'/>";
                                                  break;
                                              case "SearchBar":
                                                  componentHTML = "<input type='search' id='"+id+"' class='drawn-element searchbar "+layout+" "+platformToPreview+"' value='Search Here'/>";
                                                  break;
                                              case "Switch":
                                                  componentHTML = "<input type='checkbox' id='"+id+"' checked='checked' class='drawn-element switch "+layout+" "+platformToPreview+"'/>";
                                                  break;
                                              case "Slider":
                                                  componentHTML = "<input type='range' id='"+id+"' class='drawn-element slider "+layout+" "+platformToPreview+"' value='50'/>";
                                                  break;
                                              case "Progress":
                                                  componentHTML = "<progress id='"+id+"' class='drawn-element progress "+layout+" "+platformToPreview+"'/>";
                                                  break;
                                              case "ActivityIndicator":
                                                  componentHTML = "<div id='"+id+"' class='drawn-element activity-indicator "+layout+" "+platformToPreview+"'/>";
                                                  break;
                                              case "Image":
                                                  componentHTML = "<img id='"+id+"' class='drawn-element activity-indicator "+layout+" "+platformToPreview+"'/>";
                                                  break;
                                                
                                              default:
                                                  componentHTML = "<div>Component Unavailable</div>";
                                      
                                      }
                                      //$(componentHTML).addClass(application.screens[this.id].layout);
                                      //console.log(platformToPreview);
                                      //$(componentHTML).addClass(platformToPreview);
                                      //Checkboxes have a different behaviour
                                      if ($(componentHTML).attr("type")=="checkbox")
                                          componentHTML += "<label for='"+$(componentHTML).attr("id")+"'></label>";
                                      $(this).append(componentHTML);
                                      //Update Model
                                      //Setting a property via constructor
                                      var component = new model.Component (id,type);
                                      //Creation of an attribute at run time:
                                      application.screens[this.id].components[""+id+""] = component;
                                      application.screens[this.id].numberOfComponents++;
                                      $("#modelExplorer").append("<span class='secondLevelModel'>"+id+" - "+type+" </span>");
                                      $("#"+id).draggable({ containment: "parent" });
                                     
                                  }else{
                                        //Behaviour here to move objects (STACK LAYOUT)
                                      console.log("moved object");
                                      var movingObject = $(ui.draggable[0]).clone();
                                      $(ui.draggable[0]).remove();
                                      var target = document.elementFromPoint(event.clientX,event.clientY);
                                      if (!application.screens[""+target.id+""]){
                                          //the target is not a window
                                          $(movingObject).insertAfter(target);
                                          $(movingObject).css("top","0px");
                                          $(movingObject).draggable({ containment: "parent" });
                                          //UPDATE MODEL!!!!
                                          //Bottleneck: to update the model we need to rewrite it:
                                          var oldComponentsModule = application.screens[this.id].components;
                                          application.screens[this.id].components = {};
                                          for (var i in oldComponentsModule){
                                              if (oldComponentsModule[i].id == movingObject[0].id) continue;
                                              if (oldComponentsModule[i].id == target.id){
                                                  application.screens[this.id].components[i] = oldComponentsModule[i];
                                                  application.screens[this.id].components[movingObject[0].id] = oldComponentsModule[movingObject[0].id];
                                              }else{
                                                  application.screens[this.id].components[i] = oldComponentsModule[i];
                                              }
                                          }
                                      }else{
                                          //the target is an empty space in a window
                                          $(this).append(movingObject);
                                          $(movingObject).css("top","0px");
                                          $(movingObject).draggable({ containment: "parent" });
                                          //UPDATE MODEL!!!
                                          var toRestore = application.screens[this.id].components[movingObject[0].id];
                                          delete application.screens[this.id].components[movingObject[0].id];
                                          application.screens[this.id].components[movingObject[0].id] = toRestore;
                                      }  //$(movingObject).insertBefore(document.elementFromPoint(event.clientX,event.clientY));
                                      //console.log(document.elementFromPoint(event.clientX,event.clientY));
                                    }
                                  }
                      });
                
                
                $(".drawn-element").click(function(){
                  $(this).toggleClass('selected-element');
                    //console.log(this);
                })
            }


            
            function initialization(config){        //config[1]: working path [it is in 0 position]
               // console.log(config);
                projectName = config[1];
                workingPath = config[2];
                existingPrj = config[3];
                if (!existingPrj) buildNewProject(config);  
                else restoreProjectFromFile();       //Check Indexes
                //$("#loadingPanel").hide();
                createFileExplorer();

                /*$('#fileExplorer').fileTree({ root: config[2]+"/"+config[1] }, function(file) {
                    alert(file);
                });*/
                
                document.title += " - "+config[1];
                
                
                
                /*****************************FRONT END*******************************/
                //$("#filePanel").append(config[1]);
                
                var components = ["Screen","Label","Button","TextField","TextView","SearchBar","Switch","Slider","Progress","ActivityIndicator","Image","ListView","HtmlView","WebView","TabView","SegmentedBar","DatePicker","TimePicker","ListPicker","Dialogs"];
                
                for(var i=0; i<components.length; i++){
                    /*if (i==0) $("#componentsPanel").append("<div class='component ui-widget-content'>Screen</div>");
                    else if (i==1) $("#componentsPanel").append("<div class='component ui-widget-content'>TEXT</div>");
                    else $("#componentsPanel").append("<div class='component ui-widget-content'>Component "+i+"</div>");*/
                    $("#componentsContainer").append("<div class='component ui-widget-content'>"+components[i]+"</div>");
                }
                
                
                $( ".component" ).draggable({
                    opacity: 0.7,
                    helper: "clone",
                });
                
                
                
                $( "#mainContent" ).droppable({
                  drop: function( event, ui ) {

                      
                      switch (ui.draggable[0].innerText){
                          case "Screen": {
                              var leftOffset = ui.position.left - $("#componentsPanel").width();
                              var newId = application.numberOfScreens;
                              var newScreen = new model.Screen("win"+newId);
                              application.screens["win"+newId] = newScreen;
                              application.numberOfScreens++;
                              var firstWindowString = ""; 
                              if (application.numberOfScreens==1) firstWindowString = "(Starting Window)";
                              var sampleWindow = `<div id='win`+newId+`' class='window drawn-element `+platformToPreview+`' style='top:`+ui.position.top+`; left: `+leftOffset+`;'>
                                                  <span>win`+newId+` `+firstWindowString+`</span>
                                                  <div class="header drawn-element `+platformToPreview+`"></div>
                                                  </div>`;
                              //$(sampleWindow).appendTo($(this));
                              $("#mainContent").append(sampleWindow);
                              $("#modelExplorer").append("<span class='firstLevelModel'>win"+newId+" - Window </span>");
                              initializeWindowEvents();
                                 
                      //ui.draggable.clone().appendTo($(this)).draggable();

                  }
    
                 }}});
                
                
            }
            /*
            function notifier(event){
                switch(event){
                    case "buildSucceeded": new Notification("Build Succeeded","");
                }
            }*/
            var lineActive = false;
            function drawLine(event, compId, winId){
                console.log(event);
                //console.log(sender);
                console.log(compId);
                console.log(winId);
                
                var findElementAtClickListener = function(event){
                    $("#svg-container").remove();
                    console.log(event);
                    //bindAction(document.elementFromPoint(event.clientX,event.clientY),compId,winId);
                    console.log("win "+winId+" comp: "+compId);
                    application.screens[""+winId+""].components[""+compId+""].isDynamic = true;
                    application.screens[""+winId+""].components[""+compId+""].actions["navTo"] = document.elementFromPoint(event.clientX,event.clientY).id;
                    //console.log(document.elementFromPoint(event.clientX,event.clientY));
                    lineActive = false;
                    document.onmousemove = null;
                    $("body").unbind("click",findElementAtClickListener);
                }
                
                document.onmousemove = handleMouseMove;
                function handleMouseMove(event) {
                    var dot, eventDoc, doc, body, pageX, pageY;

                    event = event || window.event; // IE-ism

                    // If pageX/Y aren't available and clientX/Y are,
                    // calculate pageX/Y - logic taken from jQuery.
                    // (This is to support old IE)
                    if (event.pageX == null && event.clientX != null) {
                        eventDoc = (event.target && event.target.ownerDocument) || document;
                        doc = eventDoc.documentElement;
                        body = eventDoc.body;

                        event.pageX = event.clientX +
                          (doc && doc.scrollLeft || body && body.scrollLeft || 0) -
                          (doc && doc.clientLeft || body && body.clientLeft || 0);
                        event.pageY = event.clientY +
                          (doc && doc.scrollTop  || body && body.scrollTop  || 0) -
                          (doc && doc.clientTop  || body && body.clientTop  || 0 );
                    }

                    // Use event.pageX / event.pageY here
                   // console.log(event.pageX+" "+event.pageY);
                    if(!lineActive){
                        
                     $("body").prepend(`
                        <svg id="svg-container" height="100%" width="100%" style="position: absolute;">
                          <line id="lineAction" x1="`+event.clientX+`" y1="`+event.clientY+`" x2="200" y2="200" style="stroke:rgb(0,0,255);stroke-width:2" />
                        </svg>
                                `);
                        lineActive = true;
                    }else{
                        document.getElementById("lineAction").setAttribute("x2",event.pageX);
                        document.getElementById("lineAction").setAttribute("y2",event.pageY);
                    }
                    
                    /*
                    $("body").click(function(event){
                        $("#svg-container").remove();
                        console.log(document.elementFromPoint(event.clientX,event.clientY));
                        lineActive = false;
                        document.onmousemove = null;
                    })*/
                    if (lineActive)  $("body").bind("click","body",findElementAtClickListener);

                }
         
            }
            
            function createCodeEditor(){
                $("#mainContent").html("<input type='textarea' id='code' style='width:100%; height: 100%'/>");
                 codeEditor = CodeMirror.fromTextArea($("#code")[0], {
                    lineNumbers: true,
                    mode: "htmlmixed",
                    viewportMargin: Infinity,
                    lineWrapping: true,
                    theme: "lesser-dark",

                });      
                codeEditor.refresh();
                //$("#mainContent").css("overflow","hidden");
                $(".CodeMirror-scroll").css("height",parseInt($("#mainContent").css("height"))-34);
                //TODO: CHANGE SIZE ON RESIZE
            }   
        </script>
    </head>
    <body>
       <nav>
           Mobile Studio
           <span style="float: right;">Preview as: 
                <select id="previewPlatformSelector">
                   <option value="ios">iOS</option>
                   <option value="android">Android</option>
                </select>

           </span>
           <button id="saveButton" onclick="storeModel();">Save Project</button>
           <button id="compileButton" onclick="compileForNS();">Compile Project</button>
           <button id="androidGo" onclick="run('androidReal');">Run in Android (real)</button>
           <button id="iOSGo" onclick="run('iosEmulator');">Run in iOS (sim)</button>
           <button id="iOSGo" onclick="$('#consoleContainer').toggle();">Show/Hide console</button>
       </nav>
       <section id="loadingPanel">
           <h1 style="color:white;">LOADING</h1>
       </section>
       <section id="consoleContainer" style="display:none;">Console
           <div id="console">Console Started</div>
       </section>
        <table id="mainTable" style="position:absolute; height:100%;">
            <tr>
                <td id="componentsPanel">
                    <h4 style="margin-left: 10px;">File Explorer</h4>
                    <section id="fileExplorer">
                        <button onclick="createCodeEditor();">Open JS editor</button>
                        <button>Open Visual editor</button>
                    </section>
                    <hr>
                    <section id="componentsContainer"></section>
                </td>
                <td id="mainContent" style="position:relative;"> <!--TODO: rename in mainContentContainer
                     <section id="realMainContent" style="background-color:red; width:100%; height:100%;"></section>        -->
                </td>
                <td id="propertyPanel">
                    <h4>Components Explorer</h4>
                    <section id="modelExplorer"></section>
                    <hr>
                    <section id="properties"></section>   
                </td>

                </td>
            </tr>
        
        </table>

    </body>
</html>