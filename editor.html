<html>
    <head>
    <meta charset="UTF-8">
    <title>Mobile Studio v0.0.1 - Editor</title>
        <link rel="stylesheet" href="css/jqueryUI/jquery-ui.min.css">
        <link rel="stylesheet" href="css/jqueryUI/jquery-ui.structure.min.css">
        <link rel="stylesheet" href="css/jqueryUI/jquery-ui.theme.min.css">
        <link rel="stylesheet" href="css/jqueryUI/jquery.ui.ruler.css">
        
        <!--link rel="stylesheet" href="css/bootstrap/bootstrap.min.css">
        <link rel="stylesheet" href="css/bootstrap/bootstrap-theme.min.css">
        <script src="js/bootstrap/bootstrap.min.js"></script-->
        
        <script src="js/translator.js"></script>
        <script src="js/editor-backend.js"></script>
        
        <link rel="stylesheet" href="css/editor.css">

        <script>
            //var messageReceived = null;
            window.$ = window.jQuery = require('./js/jquery-3.0.0.min.js');
            require('./js/jquery-ui.min.js');
            require('./js/jquery.ui.ruler.js');
            var model = require('./classes.js');
            let application = new model.Application(); 
            $(window).ready(function() {
                  
                //Graphic Initialization
                //$( "#filePanel" ).resizable();
                $( "#componentsPanel" ).resizable();
                $( "#componentsPanel" ).droppable();
                $( "#mainContent" ).droppable();

                $( "#mainContent" ).ruler();
                  
                //Gather data from main (FOR NOW ONLY PATH)
                const {ipcRenderer} = require('electron');
                
                ipcRenderer.on('asynchronous-message', (event, arg) => {
                    //messageReceived = arg;
                    switch(arg[0]){
                        case "initialization": {initialization(arg); break;}
                        //default: console.log(arg);
                    }
                });
                
            });
            
        
            
            function deleteElement(idToDelete){
                    $("#"+idToDelete).remove();
                    $(".infoHovering").remove();
                    //Delete from model!!!
                    application.screens.splice(idToDelete,1);                    
                }
            
            
            function buildProjectForAndroid(){
                $("#loadingPanel").show();
                console.log("DO TRANSLATION HERE!")
            }


            
            function initialization(config){        //config[1]: working path [it is in 0 position]
                
                buildNewProject(config);        //Check if we need to create a new project
                $("#loadingPanel").hide();
                
                
                
                /*****************************FRONT END*******************************/
                //$("#filePanel").append(config[1]);
                
                for(var i=0; i<10; i++){
                    if (i==0) $("#componentsPanel").append("<div class='component ui-widget-content'>SCREEN</div>");
                    if (i==1) $("#componentsPanel").append("<div class='component ui-widget-content'>TEXT</div>");
                    else $("#componentsPanel").append("<div class='component ui-widget-content'>"+i+"</div>");
                }
                
                
                $( ".component" ).draggable({
                    opacity: 0.7,
                    helper: "clone",
                    //grid: [ 20, 20 ]
                });
                
                
                
                $( "#mainContent" ).droppable({
                  drop: function( event, ui ) {
                      /*console.log(ui);
                      console.log(this);
                      console.log(event);*/
                      
                      switch (ui.draggable[0].innerText){
                          case "SCREEN": {
                              var leftOffset = ui.position.left - $("#componentsPanel").width();
                              var newId = application.screens.length;
                              var newScreen = new model.Screen("win"+newId);
                              //application.screens.push("win"+newId);
                              //TODO: Analyze following
                              application.screens.push(newScreen);
                              application.screens["win"+newId] = newScreen;
                              var sampleWindow = "<div id='win"+newId+"' class='window drawn-element' style='top:"+ui.position.top+"; left: "+leftOffset+";'>Window</div>";
                              //$(sampleWindow).appendTo($(this));
                              $("#mainContent").append(sampleWindow);
                              $(".window").draggable();
                              
                              //InfoBox
                              $(".window").click(function(sender){
                                  if (sender.target.id.substring(0,3)=="win"){
                                      console.log(sender.target.id);
                                     // var infoPanel =   `<div class="infoHovering" style="top:`+ui.position.top+`; left: `+(leftOffset+400)+`;">
                                      var infoPanel =   `<div class="infoHovering" style="top:`+sender.target.style.top+`; left: `+(parseInt(sender.target.style.left)+400)+`;">
                                                            <h1>Screen`+application.screens[""+sender.target.id+""].id+`</h1>
                                                            Screen UI Element
                                                            <br/>
                                                            id: <input type="text" value="`+application.screens[""+sender.target.id+""].id+`"/>
                                                            <br/>
                                                            layout: <input type="text" value="`+application.screens[""+sender.target.id+""].layout+`"/>
                                                            <br/>
                                                            <input value="DELETE" type="submit" onclick="deleteElement('`+application.screens[""+sender.target.id+""].id+`');">

                                                        </div>`;
                                      //var infoPanel = "<h1>Ciaone</h1>";
                                      $("#mainContent").append(infoPanel);
                                  }else{
                                      var infoPanel =   `<div class="infoHovering" style="top:`+sender.target.style.top+`; left: `+(parseInt(sender.target.style.left)+400)+`;">
                                                                        <h1>Component `+application.screens[this.id].components[""+sender.target.id+""].id+`</h1>
                                                                        Screen UI Element
                                                                        <br/>
                                                                        id: <input type="text" value="`+application.screens[this.id].components[""+sender.target.id+""].id+`"/>
                                                                        <br/>
                                                                        layout: <input type="text" value="`+application.screens[this.id].components[""+sender.target.id+""].layout+`"/>
                                                                        <br/>
                                                                        <input value="DELETE" type="submit" onclick="deleteElement('`+application.screens[this.id].components[""+sender.target.id+""].id+`');">

                                                                    </div>`;
                                                  //var infoPanel = "<h1>Ciaone</h1>";
                                                  $("#mainContent").append(infoPanel);
                                  }
                               
                              });
                              $(".window").droppable({
                                  drop: function( event, ui ) {
                                        console.log("Dropping element!");
                                        
                                          switch (ui.draggable[0].innerText){
                                              case "TEXT": {
                                                  //Create Graphics
                                                  //TODO: Create better ID!!!
                                                  var id = "label"+application.screens[this.id].components.length;
                                                  var sampleTextHTML = "<div id='"+id+"' style='border-width: 1' class='drawn-element label'>HELLO WORLD!</div>";
                                                  $(this).append(sampleTextHTML);
                                                  //Update Model
                                                  //Setting a property via constructor
                                                  var component = new model.Component ("label0","label");
                                                  //Creation of an attribute at run time:
                                                
                                                  component.text = "HELLO WORLD"
                                                  //application.screens[this.id].components.push(component);
                                                  application.screens[this.id].components[""+id+""] = component;
                                                  application.screens[this.id].components.length++;
                                                  //console.log(this.id);
                                                  }
                                                  break;
                                              }
                                      //InfoBox
                                      /*
                                              $(".drawn-elment").click(function(sender){
                                                  console.log(sender.target.id);
                                                  console.log(this.id);
                                                 // var infoPanel =   `<div class="infoHovering" style="top:`+ui.position.top+`; left: `+(leftOffset+400)+`;">
                                                  var infoPanel =   `<div class="infoHovering" style="top:`+sender.target.style.top+`; left: `+(parseInt(sender.target.style.left)+400)+`;">
                                                                        <h1>Component `+application.screens[this.id].components[""+sender.target.id+""].id+`</h1>
                                                                        Screen UI Element
                                                                        <br/>
                                                                        id: <input type="text" value="`+application.screens[this.id].components[""+sender.target.id+""].id+`"/>
                                                                        <br/>
                                                                        layout: <input type="text" value="`+application.screens[this.id].components[""+sender.target.id+""].layout+`"/>
                                                                        <br/>
                                                                        <input value="DELETE" type="submit" onclick="deleteElement('`+application.screens[this.id].components[""+sender.target.id+""].id+`');">

                                                                    </div>`;
                                                  //var infoPanel = "<h1>Ciaone</h1>";
                                                  $("#mainContent").append(infoPanel);
                                                  
                                                  
                               
                              });*/
                                  }
                      });    
                      //ui.draggable.clone().appendTo($(this)).draggable();

                  }
    
                 }}});
                
                
            }
                
           
            
        </script>
    </head>
    <body>
       <nav>
           Mobile Studio
           <button id="androidGo">Compile for Android</button>
           <button id="iOSGo">Compile for iOS</button>
       </nav>
       <section id="loadingPanel">
           <h1 style="color:white;">LOADING</h1>
       </section>
        <table style="position:absolute;">
            <tr>
                <!--td id="filePanel"><small>Working Directory</small><br></td-->
                <td id="componentsPanel"></td>
                <td id="mainContent" style="position:relative;"> <!--TODO: rename in mainContentContainer
                     <section id="realMainContent" style="background-color:red; width:100%; height:100%;"></section>        -->
                </td>
            </tr>
        
        </table>
        <!--
        <aside id="filePanel" style="display:table-cell">Active Files</aside>
        <aside id="componentsPanel" style="display:table-cell"></aside>-->
    </body>
</html>